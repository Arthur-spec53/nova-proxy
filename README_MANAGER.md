# Nova Proxy 管理工具使用指南

## 概述

`nova-manager.sh` 是一个保姆级别的命令行管理工具，提供了 Nova Proxy 项目的完整部署、管理和维护功能。通过交互式菜单界面，即使是初学者也能轻松管理复杂的微服务架构。

## 快速开始

### 启动管理工具

```bash
# 进入项目目录
cd /path/to/nova-proxy

# 运行管理脚本
./scripts/nova-manager.sh
```

### 首次使用建议流程

1. **系统检查** (选项 1) - 评估系统资源并获取部署建议
2. **选择部署方案** (选项 2-5) - 根据系统检查结果选择合适的部署
3. **查看服务状态** (选项 6) - 确认服务正常运行
4. **访问服务** (选项 13) - 获取监控面板访问地址

## 功能模块详解

### 🚀 部署管理 (选项 1-5)

#### 1. 系统检查和部署建议
- 自动检测系统资源（内存、CPU、磁盘）
- 检查 Docker 环境和端口占用
- 基于评分系统推荐最适合的部署方案
- 提供针对性的优化建议

#### 2. 核心服务部署 (最小资源)
- **适用场景**: 资源极度受限的环境 (< 1GB 内存)
- **包含服务**: 仅 Nova Server
- **资源需求**: ~256MB 内存
- **特点**: 无监控组件，最小化资源占用

#### 3. 轻量级部署 (含可选监控)
- **适用场景**: 中等配置环境 (1-2GB 内存)
- **包含服务**: Nova Server + 可选监控 (Prometheus, Grafana)
- **资源需求**: ~1GB 内存
- **特点**: 平衡功能与资源消耗

#### 4. 完整部署 (全套监控)
- **适用场景**: 生产环境或高配置开发环境 (4GB+ 内存)
- **包含服务**: Nova Server + Prometheus + Grafana + Jaeger
- **资源需求**: ~4-6GB 内存
- **特点**: 完整的可观测性栈

#### 5. 开发环境部署
- **适用场景**: 开发和调试
- **特点**: 启用调试模式，热重载，详细日志
- **配置文件**: 使用 `docker-compose.dev.yml`

### 🔧 服务管理 (选项 6-10)

#### 6. 查看服务状态
- 显示所有容器的运行状态
- 实时资源使用情况 (CPU、内存、网络、磁盘)
- 自动检测当前使用的配置文件

#### 7-9. 启动/停止/重启服务
- 批量管理所有服务
- 自动检测配置文件
- 操作后显示服务状态确认

#### 10. 查看服务日志
- **子菜单选项**:
  - Nova Server 日志
  - Prometheus 日志
  - Grafana 日志
  - Jaeger 日志
  - 所有服务日志
- 支持实时日志跟踪 (`-f` 参数)

### 📊 监控管理 (选项 11-14)

#### 11-12. 启用/禁用监控组件
- 动态控制监控服务运行状态
- 不影响核心服务运行
- 节省资源的灵活方案

#### 13. 监控面板访问地址
显示所有服务的访问信息：
- **Nova Proxy 服务**:
  - HTTP: http://localhost:8080
  - HTTPS: https://localhost:8443
  - 管理接口: http://localhost:8081/admin
- **监控服务**:
  - Prometheus: http://localhost:9090
  - Grafana: http://localhost:3000 (admin/admin123)
  - Jaeger: http://localhost:16686

#### 14. 资源使用监控
- 实时系统资源监控 (内存、CPU、磁盘)
- Docker 容器资源使用情况
- 5秒刷新间隔，按 Ctrl+C 退出

### ⚙️ 配置管理 (选项 15-18)

#### 15. 查看当前配置
- 显示当前 `.env` 文件内容
- 列出可用的配置文件
- 配置文件状态检查

#### 16. 修改环境变量
提供向导式配置修改：

**16.1 日志级别设置**
- `debug`: 详细调试信息 (开发环境)
- `info`: 一般信息 (默认)
- `warn`: 仅警告和错误 (生产环境)
- `error`: 仅错误信息 (最小日志)

**16.2 服务端口配置**
- HTTP 端口 (默认: 8080)
- HTTPS 端口 (默认: 8443)
- 管理端口 (默认: 8081)

**16.3 资源限制设置**
- Nova Server 内存限制 (如: 256m, 512m, 1g)
- Nova Server CPU 限制 (如: 0.5, 1, 2)

**16.4 监控配置**
- 启用/禁用指标收集
- Prometheus 数据保留期设置

**16.5 直接编辑**
- 使用系统默认编辑器 (nano/vi) 直接编辑 `.env` 文件

#### 17. 备份配置
- 自动创建时间戳备份目录
- 备份 `.env`、`docker-compose.yml` 和 `configs/` 目录
- 备份路径: `backups/YYYYMMDD_HHMMSS/`

#### 18. 恢复配置
- 列出所有可用备份
- 选择性恢复配置文件
- 支持完整配置恢复

### 🛠️ 维护工具 (选项 19-23)

#### 19. 性能测试
- 自动检测并运行 `scripts/performance.sh`
- 内置简单 HTTP 连接性能测试
- 5次连接测试，显示响应时间

#### 20. 清理数据
提供多级清理选项：
- **清理 Docker 镜像和容器**: 清理未使用的镜像和容器
- **清理监控数据**: 删除 Prometheus 和 Grafana 数据卷
- **清理日志文件**: 删除 `.log` 文件和 Docker 日志
- **完全清理**: 删除所有数据包括数据卷 (⚠️ 不可恢复)

#### 21. 更新镜像
- 拉取最新的外部镜像
- 重新构建本地镜像 (无缓存)
- 自动重启服务应用更新

#### 22. 故障排除
自动运行诊断检查：
- Docker 服务状态
- 端口占用情况
- 容器运行状态
- 磁盘和内存使用
- 容器日志错误分析

#### 23. 完全卸载服务
- 彻底删除所有 Nova Proxy 相关的服务、数据和配置
- 停止并删除所有容器
- 删除 Docker 镜像和数据卷
- 清理配置文件和日志
- ⚠️ 此操作不可恢复，请谨慎使用

## 使用技巧和最佳实践

### 🎯 部署策略建议

1. **首次部署**:
   ```
   系统检查 → 选择合适部署方案 → 查看服务状态 → 获取访问地址
   ```

2. **资源受限环境**:
   ```
   核心部署 → 运行稳定后 → 启用监控组件
   ```

3. **生产环境**:
   ```
   完整部署 → 配置备份 → 性能测试 → 监控设置
   ```

### 🔍 故障排除流程

1. **服务无法启动**:
   - 运行系统检查 (选项 1)
   - 查看服务状态 (选项 6)
   - 检查服务日志 (选项 10)
   - 运行故障排除 (选项 22)

2. **性能问题**:
   - 资源使用监控 (选项 14)
   - 调整资源限制 (选项 16.3)
   - 运行性能测试 (选项 19)

3. **配置问题**:
   - 查看当前配置 (选项 15)
   - 恢复备份配置 (选项 18)
   - 重新部署服务

### 📋 维护计划建议

#### 日常维护
- 查看服务状态和资源使用
- 检查服务日志是否有异常

#### 周期性维护
- 备份重要配置 (每周)
- 清理不必要的数据 (每月)
- 更新镜像和依赖 (按需)

#### 紧急维护
- 故障排除和日志分析
- 服务重启和配置恢复

## 环境要求

### 必需依赖
- Docker (20.10+)
- Docker Compose (1.29+ 或 Docker Compose V2)
- Bash (4.0+)

### 可选工具
- curl (用于性能测试)
- nano/vi (用于配置编辑)
- netstat (用于端口检查)

### 系统要求
- **最小配置**: 1GB RAM, 1 CPU, 10GB 磁盘
- **推荐配置**: 4GB RAM, 2 CPU, 50GB 磁盘
- **操作系统**: Linux (Ubuntu 18.04+, CentOS 7+, Debian 9+)

## 常见问题解答

### Q: 如何选择合适的部署方案？
A: 运行系统检查 (选项 1)，脚本会根据你的硬件配置自动推荐最适合的方案。

### Q: 可以在运行时切换部署方案吗？
A: 可以。先停止当前服务，然后选择新的部署方案。数据会保留在 Docker 卷中。

### Q: 如何备份和恢复配置？
A: 使用选项 17 进行备份，选项 18 进行恢复。建议在重要配置更改前先备份。

### Q: 监控组件占用太多资源怎么办？
A: 可以使用选项 12 临时禁用监控组件，或切换到轻量级部署方案。

### Q: 如何查看详细的错误信息？
A: 使用选项 10 查看具体服务的日志，或选项 22 运行完整的故障排除。

### Q: 端口冲突怎么解决？
A: 使用选项 16.2 修改服务端口，或选项 22 检查端口占用情况。

## 支持和反馈

如果在使用过程中遇到问题：

1. 首先运行故障排除 (选项 22)
2. 查看相关服务日志 (选项 10)
3. 检查系统资源状况 (选项 14)
4. 参考项目文档和 GitHub Issues

---

**提示**: 这个管理工具设计为保姆级别，每个操作都有详细的提示和确认。如果你是初学者，建议按照菜单顺序逐步操作，遇到问题时多使用故障排除功能。